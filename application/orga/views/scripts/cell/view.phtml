<?php
$inventoryStatusFilters = [
    null => 'Toute collecte',
    Orga_Model_Cell::STATUS_NOTLAUNCHED => __('Orga', 'inventory', 'notLaunched'),
    Orga_Model_Cell::STATUS_ACTIVE => __('UI', 'property', 'open'),
    Orga_Model_Cell::STATUS_CLOSED => __('UI', 'property', 'closed'),
];
$inputStatusFilters = [
    null => 'Tout status',
    AF_Model_InputSet_Primary::STATUS_FINISHED => __('AF', 'inputInput', 'statusFinished'),
    AF_Model_InputSet_Primary::STATUS_COMPLETE => __('AF', 'inputInput', 'statusComplete'),
    AF_Model_InputSet_Primary::STATUS_CALCULATION_INCOMPLETE => __('AF', 'inputInput', 'statusCalculationIncomplete'),
    AF_Model_InputSet_Primary::STATUS_INPUT_INCOMPLETE => __('AF', 'inputInput', 'statusInputIncomplete'),
    'notStarted' => __('AF', 'inputInput', 'statusNotStarted'),
];
?>

<style>
    .granularity > .cell.firstRowCell { margin-left: 0; }
    .progress { margin-bottom: 5px; }
    #addMembers { margin: 0; }
    #addMembers .controls { margin-left: 0; }
    #addMembers .subGroup { margin-left: 0; }
    #addMembers label { text-align: left; width: 35%; }
    #addMembers .input { width: auto; }
    #addMembers .form-actions { padding-left: 0; padding-bottom: 0; margin-bottom: 0; margin-top: 0px; }
</style>

<?php
/** @var \Orga\ViewModel\OrganizationViewModel $organization */
$organization = $this->organization;
?>
<div class="organization well alert-info">
    <?php if ($organization->canBeEdited) : ?>
        <div class="pull-right">
            <a class="editOrganization btn btn-small btn-primary"
               href="orga/organization/edit/idOrganization/<?=$organization->id?>">
                <i class="icon-cog icon-white"></i>
                <?=__('UI', 'verb', 'edit')?>
            </a>
        </div>
    <?php endif; ?>

    <h1>
        <?=$organization->label?>
    </h1>
</div>

<div class="row-fluid">

    <div class="span9">

        <?php
        /** @var \Orga\ViewModel\CellViewModel $currentCell */
        $currentCell = $this->currentCell;
        ?>
        <div class="currentCell well">
            <h2>
                <?php if ($currentCell->canBeInputted) : ?>
                <a href="orga/cell/input/idCell/<?=$currentCell->id?>/fromIdCell/<?=$currentCell->id?>">
                    <?php endif; ?>
                    <?=$currentCell->extendedLabel?>
                    <?php if ($currentCell->canBeInputted) : ?>
                </a>
            <?php endif; ?>
            </h2>
            <p>
                <a data-toggle="modal" data-target="#administrators<?=$currentCell->id?>" href="#">
                    <i class="icon-search"></i>
                    Contacter les administrateurs
                </a>
            </p>
            <?php if ($currentCell->canBeAnalyzed) : ?>
            <p>
                <a data-toggle="modal" data-target="#reports<?=$currentCell->id?>" href="orga/tab_celldetails/analyses/idCell/<?=$currentCell->id?>">
                    <i class="icon-tasks"></i>
                    Voir les rapports
                </a>
            </p>
            <?php endif; ?>
            <p>
                <a data-toggle="modal" data-target="#exports<?=$currentCell->id?>" href="orga/tab_celldetails/exports/idCell/<?=$currentCell->id?>">
                    <i class="icon-download-alt"></i>
                    Voir les exports
                </a>
            </p>
            <?php if ($currentCell->inventoryStatus !== null) : ?>
            <p>
                <b><?=__('Orga', 'inventory', 'inventoryStatus')?>&nbsp;:&nbsp;</b>
                <?=$currentCell->inventoryStatus?>
            </p>
            <p>
                <?=$currentCell->inventoryNotStartedInputsNumber?> non commencée
                <?php if ($currentCell->inventoryNotStartedInputsNumber > 1) : echo 's'; endif; ?>
                |
                <?=$currentCell->inventoryStartedInputsNumber?> en cours
                <?php if ($currentCell->inventoryStartedInputsNumber > 1) : echo 's'; endif; ?>
                |
                <?=$currentCell->inventoryCompletedInputsNumber?> terminée
                <?php if ($currentCell->inventoryCompletedInputsNumber > 1) : echo 's'; endif; ?>
            </p>
            <div class="progress">
                <div class="bar" style="width: <?=$currentCell->inventoryCompletion?>%"><?=$currentCell->inventoryCompletion?> %</div>
            </div>
            <?php endif; ?>
            <?php if ($currentCell->canBeInputted) : ?>
            <p>
                <b><?=__('Orga', 'input', 'inputStatus')?>&nbsp;:&nbsp;</b>
                <?=$currentCell->inputStatusTitle?>
            </p>
            <div class="progress <?=$currentCell->inputStatusStyle?>">
                <div class="bar" style="width: <?=$currentCell->inputCompletion?>%"><?=$currentCell->inputCompletion?> %</div>
            </div>
            <?php endif; ?>

            <div id="administrators<?=$currentCell->id?>" class="modal hide fade">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4>Administrateur de <?=$currentCell->shortLabel?></h4>
                </div>
                <div class="modal-body">
                    <pre><?=implode("\n", $currentCell->administrators)?></pre>
                </div>
            </div>

            <?php if ($currentCell->canBeAnalyzed) : ?>
            <div id="reports<?=$currentCell->id?>" class="modal reports hide fade large">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4>Rapports de <?=$currentCell->shortLabel?></h4>
                </div>
                <div class="modal-body">
                    <div class="granularity row-fluid">
                        <img src="images/ui/ajax-loader_large.gif"> Chargement des rapports en cours
                    </div>
                </div>
            </div>
            <?php endif; ?>
            <div id="exports<?=$currentCell->id?>" class="modal exports hide fade large">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4>Exports de <?=$currentCell->shortLabel?></h4>
                </div>
                <div class="modal-body">
                    <div class="granularity row-fluid">
                        <img src="images/ui/ajax-loader_large.gif"> Chargement des exports en cours
                    </div>
                </div>
            </div>
        </div>

        <?php foreach ($this->narrowerGranularities as $narrowerGranularity) :
            /** @var Orga_Model_Granularity $narrowerGranularity */
            try {
                $granularityForInventoryStatus = $narrowerGranularity->getOrganization()->getGranularityForInventoryStatus();
            } catch (Core_Exception_UndefinedAttribute $e) {
                $granularityForInventoryStatus = null;
            }
            if (($narrowerGranularity === $granularityForInventoryStatus) || ($narrowerGranularity->isNarrowerThan($granularityForInventoryStatus))) {
                $displayInventoryStatusFilter = true;
            } else {
                $displayInventoryStatusFilter = false;
            }
        ?>
        <fieldset class="wrapper">
            <legend data-toggle="collapse" data-target="#granularity<?=$narrowerGranularity->getId()?>">
                <i class="filterChevron icon-chevron-down"></i>
                <?=$narrowerGranularity->getLabel()?>
                <small>
                    <?php
                    $actions = [];
                    if ($narrowerGranularity === $this->granularityForInventoryStatus || $narrowerGranularity->isNarrowerThan($this->granularityForInventoryStatus)) { $actions[] = 'Collecte' ;}
                    if ($narrowerGranularity->getInputConfigGranularity() !== null) { $actions[] = 'Saisies' ;}
                    if ($narrowerGranularity->getCellsGenerateDWCubes()) { $actions[] = 'Analyses' ;}
                    echo implode('&nbsp;&&nbsp;', $actions);
                    ?>
                </small>
            </legend>

            <div id="granularity<?=$narrowerGranularity->getId()?>" class="collapse">
                <?php if ($narrowerGranularity->hasAxes() || ($narrowerGranularity->getInputConfigGranularity() !== null)) : ?>
                <form class="form-inline cells-filter">
                    <?php foreach ($narrowerGranularity->getAxes() as $axis) : ?>
                        <select data-filter="path">
                            <option value="">Tout <?=$axis->getLabel()?></option>
                            <?php foreach ($axis->getMembers() as $member) : ?>
                                <option value="<?=$member->getCompleteRef()?>"><?=$member->getLabel()?></option>
                            <?php endforeach; ?>
                        </select>
                    <?php endforeach; ?>
                    <?php if ($narrowerGranularity->getInputConfigGranularity() !== null) : ?>
                        <select data-filter="inputstatus">
                            <?php foreach ($inputStatusFilters as $statusValue => $statusLabel) : ?>
                                <option value="<?=$statusValue?>"><?=$statusLabel?></option>
                            <?php endforeach; ?>
                        </select>
                    <?php endif; ?>
                    <?php if ($displayInventoryStatusFilter) : ?>
                        <select data-filter="inventorystatus">
                            <?php foreach ($inventoryStatusFilters as $statusValue => $statusLabel) : ?>
                                <? if ($statusValue === Orga_Model_Cell::STATUS_ACTIVE) : ?>
                                    <option value="<?=$statusValue?>" selected><?=$statusLabel?></option>
                                <?php else: ?>
                                    <option value="<?=$statusValue?>"><?=$statusLabel?></option>
                                <?php endif ?>
                            <?php endforeach ?>
                        </select>
                    <?php endif; ?>
                    <button class="btn reset"><i class="icon-zoom-out"></i> Reset</button>
                </form>
                <?php endif; ?>

                <div class="granularity row-fluid">
                    <img src="images/ui/ajax-loader_large.gif"> Chargement des cellules en cours
                </div>
            </div>
        </fieldset>
        <?php endforeach; ?>

    </div>

    <div class="span3">
        <div class="well">
            <h4>Historique</h4>
            <hr/>
            <div>
                <?=$this->partial('events/recent.phtml', 'audittrail', ['idCell' => $currentCell->id, 'entries' => $this->entries]);?>
            </div>
        </div>
        <div class="well">
            <h4>Commentaires</h4>
            <hr/>
            <div>
                <?=$this->partial('/tab/celldetails/comments.phtml',['comments' => $this->comments]); ?>
            </div>
        </div>
        <?php if ($organization->canBeEdited) : ?>
            <div class="well">
                <h4>
                    Ajouter un membre
                    <div class="pull-right">
                        <a class="editOrganization btn btn-small btn-primary"
                           href="orga/organization/edit/idOrganization/<?=$organization->id?>/tab/members">
                            <i class="icon-cog icon-white"></i>
                            <?=__('UI', 'verb', 'edit')?>
                        </a>
                    </div>
                </h4>
                <hr/>
                <?=$this->addMembersForm->display()?>
            </div>
        <?php endif; ?>
    </div>

</div>
<script>
    $('div.collapse[id^="granularity"]').on('show', function(e) {
        var granularity = $('.granularity', $(this));
        if (!granularity.data('initialized')) {
            var granularityId = $(this).attr('id').substr(11, $(this).attr('id').length);
            $.get(
                'orga/cell/viewchildren/idCell/<?=$currentCell->id?>/idGranularity/' + granularityId,
                function(o) {
                    granularity.html('');
                    $(o).each(function() {
                        var cellTitle = this.extendedLabel;
                        if (this.canBeInputted) {
                            cellTitle = '<a href="orga/cell/input/idCell/23/fromIdCell/' + this.id + '">' + cellTitle + '</a>';
                        }
                        var exportsP =
                            '<p>' +
                                '<a data-toggle="modal" data-target="#exports' + this.id + '" href="orga/tab_celldetails/exports/idCell/' + this.id + '">' +
                                '<i class="icon-download-alt"></i> Voir les exports' +
                                '</a>' +
                            '</p>';
                        var exportsPopup =
                            '<div id="exports' + this.id + '" class="modal exports hide fade large">' +
                                '<div class="modal-header">' +
                                    '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                                    '<h4>Exports de ' + this.shortLabel + '</h4>' +
                                '</div>' +
                                '<div class="modal-body">' +
                                    '<img src="images/ui/ajax-loader_large.gif"> Chargement des exports en cours' +
                                '</div>' +
                            '</div>';
                        var reportsP = '';
                        var reportsPopup = '';
                        if (this.canBeAnalyzed) {
                            reportsP =
                                '<p>' +
                                    '<a data-toggle="modal" data-target="#reports' + this.id + '" href="orga/tab_celldetails/analyses/idCell/' + this.id + '">' +
                                        '<i class="icon-tasks"></i> Voir les rapports' +
                                    '</a>' +
                                '</p>';
                            reportsPopup =
                                '<div id="reports' + this.id + '" class="modal reports hide fade large">' +
                                    '<div class="modal-header">' +
                                        '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                                        '<h4>Rapports de ' + this.shortLabel + '</h4>' +
                                    '</div>' +
                                    '<div class="modal-body">' +
                                        '<img src="images/ui/ajax-loader_large.gif"> Chargement des rapports en cours' +
                                    '</div>' +
                                '</div>';
                        }
                        var inventoryP = '';
                        if (this.inventoryStatus != null) {
                            inventoryP =
                                '<p><b><?=__('Orga', 'inventory', 'inventoryStatus')?>&nbsp;:&nbsp;</b>' + this.inventoryStatusTitle + '</p>' +
                                '<p>' +
                                    this.inventoryNotStartedInputsNumber + ' non commencée' +
                                    ((this.inventoryNotStartedInputsNumber > 1) ? 's' : '') +
                                    ' | ' +
                                    this.inventoryStartedInputsNumber + ' en cours' +
                                    ((this.inventoryStartedInputsNumber > 1) ? 's' : '') +
                                    ' | ' +
                                    this.inventoryCompletedInputsNumber + ' terminée' +
                                    ((this.inventoryCompletedInputsNumber > 1) ? 's' : '') +
                                '</p>' +
                                '<div class="progress">' +
                                '   <div class="bar" style="width: ' + this.inventoryCompletion + '%">' + this.inventoryCompletion + ' %</div>' +
                                '</div>';
                        }
                        var inputStatusP = '';
                        if (this.canBeInputted) {
                            inputStatusP =
                                '<p><b><?=__('Orga', 'input', 'inputStatus')?>&nbsp;:&nbsp;</b>' + this.inputStatusTitle + '</p>' +
                                '<div class="progress ' + this.inputStatusStyle + '">' +
                                '   <div class="bar" style="width: ' + this.inputCompletion + '%">' + this.inputCompletion + ' %</div>' +
                                '</div>';
                        }
                        granularity.append(
                        '<div class="span4 well cell" data-path="' + this.path + '" data-inputstatus="' + this.inputStatus + '" data-inventorystatus="' + this.inventoryStatus + '">' +
                            '<h4>' + cellTitle + '</h4>' +
                            reportsP +
                            exportsP +
                            inventoryP +
                            inputStatusP +
                            reportsPopup +
                            exportsPopup +
                        '</div>'
                        );
                    });
                    $('select:first', granularity.parent()).trigger('change');
                    granularity.data('initialized', true);
                }
            ).error(function(o) {

            });
        }
    });
    $('.cells-filter button.reset').click(function(e) {
        e.preventDefault();
        var form = $(e.target).parent();
        var granularity = form.next();
        $('.cell', granularity).removeClass('hide');
        $('.cell', granularity).removeClass('firstRowCell');
        $('.cell:nth-child(3n+1)', granularity).each(function() { $(this).addClass('firstRowCell'); });
        $('select', form).each(function() { $(this).val(''); });
    });
    $('.cells-filter select').change(function(e) {
        e.preventDefault();
        var form = $(e.target).parent();
        var granularity = form.next();

        $('.cell', granularity).removeClass('hide');
        $('.cell', granularity).removeClass('firstRowCell');

        var test = '';
        $('select', form).each(function() {
            var filter = $(this).data('filter');
            var value = $(this).val();
            if ((filter == 'inputstatus') && (value == 'notStarted')) {
                test += '[data-' + filter + '=\'\']';
            } else if (value != '') {
                test += '[data-' + filter + '*=\'' + value + '\']';
            }
        });
        if (test != '') {
            $('.cell:not('+ test + ')', granularity).addClass('hide');
        }

        var numberElement = 0;
        $('.cell:not(.hide)', granularity).each(function() {
            if ((numberElement % 3) == 0) {
                $(this).addClass('firstRowCell');
            }
            numberElement++;
        });
    });
</script>
