<?php

use AF\Domain\InputSet\PrimaryInputSet;
use Orga\ViewModel\CellViewModel;
use Orga\Model\ACL\CellAdminRole;
use Orga\Model\ACL\CellManagerRole;
use Orga\Model\ACL\CellContributorRole;
use Orga\Model\ACL\CellObserverRole;
use Account\Application\ViewModel\OrganizationView;

$inventoryStatusFilters = [
    null => ___('Orga', 'view', 'allInventoryStatus'),
    Orga_Model_Cell::INVENTORY_STATUS_NOTLAUNCHED => ___('Orga', 'view', 'inventoryNotLaunched'),
    Orga_Model_Cell::INVENTORY_STATUS_ACTIVE => ___('Orga', 'view', 'inventoryOpen'),
    Orga_Model_Cell::INVENTORY_STATUS_CLOSED => ___('Orga', 'view', 'inventoryClosed'),
];
$inputStatusFilters = [
    null => ___('Orga', 'view', 'allInputStatus'),
    Orga_Model_Cell::INPUT_STATUS_FINISHED => ___('AF', 'inputInput', 'statusFinished'),
    Orga_Model_Cell::INPUT_STATUS_COMPLETE => ___('AF', 'inputInput', 'statusComplete'),
    Orga_Model_Cell::INPUT_STATUS_CALCULATION_INCOMPLETE => ___('AF', 'inputInput', 'statusCalculationIncomplete'),
    Orga_Model_Cell::INPUT_STATUS_INPUT_INCOMPLETE => ___('AF', 'inputInput', 'statusInputIncomplete'),
    Orga_Model_Cell::INPUT_STATUS_NOT_STARTED => ___('Orga', 'view', 'statusNotStarted'),
    Orga_Model_Cell::INPUT_STATUS_AF_NOT_CONFIGURED => ___('Orga', 'view', 'statusAFNotConfigured'),
];

$defaultDataFirstCell = 0;

/** @var OrganizationView $organization */
$organization = $this->organization;
/** @var CellViewModel $currentCell */
$currentCell = $this->currentCell;

$workspaceBanner = null;
$file = glob(APPLICATION_PATH . '/../public/workspaceBanners/' . $organization->id . '.*');
if (count($file) > 0) {
    $workspaceBanner = 'workspaceBanners/' . pathinfo(array_pop($file))['filename'];
}
?>

<style xmlns="http://www.w3.org/1999/html">
    .organization h1 img { max-height: 125px; }
    .organization h1 .pull-right small a { letter-spacing: normal; }

    .modal .modal-loading { width: 100%; text-align: center; }

    .users .user-message { font-weight: bold; }
    .users .modal-body { padding: 0; }
    .users .modal-body .modal-loading { padding: 20px; }
    .users .modal-body table { margin: 0; }
    .users .modal-body tr.user-message td:first-child { text-align: center; }
    .users .modal-body tr.user-message .btn { margin: 0 5px 0 5px; }
    .users .modal-body tr.user-message .close-user-message { float: none; font-size: inherit; opacity: 1; }
    .users .modal-body .delete-user { color: #000000; }
    .users .modal-body .delete-user + .tooltip.left { margin-left: -15px; }
    .users .modal-footer div.user-message { text-align: center; margin-bottom: 5px; }
    .users .modal-footer form { margin: 0; }

    .reports .report-message { font-weight: bold; }
    .reports .modal-body { padding: 0; }
    .reports .modal-body .modal-loading { padding: 20px; }
    .reports .modal-body table { margin: 0; }
    .reports .modal-body tr.report-message td:first-child { text-align: center; }
    .reports .modal-body tr.report-message .btn { margin: 0 5px 0 5px; }
    .reports .modal-body tr.report-message .close-report-message { float: none; font-size: inherit; opacity: 1; }
    .reports .modal-body .delete-report + .tooltip.left { margin-left: -15px; }
    .reports .filter-reports { display: inline-block; margin-bottom: 0; }

    .exports .modal-body { text-align: center; }
    .exports .modal-body .alert { margin-bottom: 5px; }
    .exports .modal-body form { margin: 0; }

    .cell td { padding: 0 !important; }
    .cell .cell-member { font-size: 12px; line-height: 1.5; vertical-align: middle; }
    .cell td:last-child { text-align: right; }
    .cell td:last-child > * { margin: 0 5px; vertical-align: top; }
    .cell .input-status, .cell .inventory-status { position: relative; top: 7px; padding: 6px 10px 5px; color: #ffffff; background-color: #bbbbbb; border: 1px solid #cccccc; border-radius: 2px; font-weight: normal; text-align: center; vertical-align: middle; white-space: nowrap; }
    .cell[data-input-status="<?=Orga_Model_Cell::INPUT_STATUS_FINISHED?>"] .input-status { background-color: #57a957; }
    .cell[data-input-status="<?=Orga_Model_Cell::INPUT_STATUS_COMPLETE?>"] .input-status { background-color: #f0ad4e; }
    .cell[data-input-status="<?=Orga_Model_Cell::INPUT_STATUS_CALCULATION_INCOMPLETE?>"] .input-status { background-color: #dd514c; }
    .cell[data-input-status="<?=Orga_Model_Cell::INPUT_STATUS_INPUT_INCOMPLETE?>"] .input-status { background-color: #f0ad4e; }
    .cell[data-input-status="<?=Orga_Model_Cell::INPUT_STATUS_NOT_STARTED?>"] .input-status { background-color: #f0ad4e; }
    .cell[data-inventory-status="<?=Orga_Model_Cell::INVENTORY_STATUS_ACTIVE?>"] .inventory-status { background-color: #49afcd; }
    .cell[data-inventory-status="<?=Orga_Model_Cell::INVENTORY_STATUS_CLOSED?>"] .inventory-status { background-color: #a4e3f0; }
    .cell .inventory-progress { position: relative; display: inline-block; padding: 6px 10px 5px; min-width: 100px; color: #ffffff; background-color: #bbbbbb; border: 1px solid #cccccc; border-radius: 2px; }
    .cell .inventory-progress .inventory-progress-bar { position: absolute; top: 0; left: 0; height: 100%; background-color: #888888; }
    .cell .inventory-completion { position: relative; display: inline-block; width: 100%; text-align: center; font-weight: bold; }
    .cell .inventory-actions .change-inventory-status.btn { width:75px; }
    .cell .show-users { width:65px; }

    .cell:hover .input-status, .cell:hover .inventory-status { background-color: #cfcfcf; }
    .cell:hover[data-input-status="<?=Orga_Model_Cell::INPUT_STATUS_FINISHED?>"] .input-status { background-color: #6bbd6b; }
    .cell:hover[data-input-status="<?=Orga_Model_Cell::INPUT_STATUS_COMPLETE?>"] .input-status { background-color: #ffc162; }
    .cell:hover[data-input-status="<?=Orga_Model_Cell::INPUT_STATUS_CALCULATION_INCOMPLETE?>"] .input-status { background-color: #f16560; }
    .cell:hover[data-input-status="<?=Orga_Model_Cell::INPUT_STATUS_INPUT_INCOMPLETE?>"] .input-status { background-color: #ffc162; }
    .cell:hover[data-input-status="<?=Orga_Model_Cell::INPUT_STATUS_AF_NOT_CONFIGURED?>"] .input-status { background-color: #ffc162; }
    .cell:hover[data-inventory-status="<?=Orga_Model_Cell::INVENTORY_STATUS_ACTIVE?>"] .inventory-status { background-color: #5dc3e1; }
    .cell:hover[data-inventory-status="<?=Orga_Model_Cell::INVENTORY_STATUS_CLOSED?>"] .inventory-status { background-color: #b8f7ff; }
    .cell:hover .inventory-progress { background-color: #cfcfcf; }
    .cell:hover .inventory-progress-bar { background-color: #9c9c9c; }

    .granularity-wrapper legend { margin-bottom: 5px; }
    .granularity-wrapper legend small { margin-left: 5px; font-size: 75%; }
    .granularity-wrapper .cells-filter { margin-bottom: 15px; }
    .granularity-wrapper .cells-filter .granularity-info { vertical-align: middle; font-size: 14px; font-weight: normal; line-height: 20px; padding: 4px 12px; }
    .granularity-wrapper .loading-cells, .granularity-wrapper .no-cell, .granularity-wrapper .change-cells-display { text-align: center; }

    #currentGranularity .cell td { border: none; }

    .history,
    .comments
    { margin-bottom: 15px; }
    .history > h3,
    .comments > h3
    { margin: 0; }
    .history > h3 small,
    .comments > h3 small
    { margin-top: 15px; }
    .history h4,
    .comments h4
    { border-bottom: 1px solid #eeeeee; margin-bottom: 20px; margin-top: 0; }
    .history h4 span,
    .comments h4 span
    { position: relative; top: 10px; padding-right: 5px; color: #999999; }
    .history div.row div.col-md-2,
    .comments div.row div.col-md-2
    { color: #999999; font-size: small; font-weight: normal; text-align: right; white-space: nowrap; }
    .history div.row + div.row,
    .comments div.row + div.row
    { border-top: solid 1px #eeeeee; margin-top: 8px; padding-top: 8px; }
    .history > div > div + div,
    .comments >div > div + div
    { margin-top: 5px;  }
</style>

<div class="organization page-header">
    <h1>
        <?php if ($organization->canBeEdited) : ?>
            <div class="pull-right">
                <small>
                    <a class="editOrganization btn btn-sm btn-default"
                       href="orga/organization/edit/idOrganization/<?=$organization->id?>/">
                        <i class="fa fa-wrench fa-fw"></i>
                        <?=___('UI', 'name', 'configurationOrga')?>
                    </a>
                </small>
            </div>
        <?php endif; ?>
        <?php if ($workspaceBanner === null) : ?>
            <?=$organization->label?>
        <?php else : ?>
            <img src="<?=$workspaceBanner?>">
        <?php endif; ?>
    </h1>
</div>

<div class="row">

<div class="col-md-9" id="cellsView">

    <fieldset class="collapse-wrapper granularity-wrapper">
        <legend data-closed-indicator="<i class=&quot;fa fa-chevron-right fa-fw&quot;></i>" data-opened-indicator="<i class=&quot;fa fa-chevron-down fa-fw&quot;></i>">
            <a data-toggle="collapse" href="#currentGranularity">
                <i class="fa fa-chevron-down fa-fw"></i>
                <?=__('Orga', 'view', 'currentGranularity')?>
                <small>
                    <i>
                        <?=___('Orga', 'view', 'granularityExplanations')?><?=$this->currentCellPurpose?>
                    </i>
                </small>
            </a>
        </legend>

        <div id="currentGranularity" class="collapse in">
            <table class="granularity table table-condensed table-hover">
                <tr class="cell" data-inventory-status="<?=$currentCell->inventoryStatus?>" data-input-status="<?=$currentCell->inputStatus?>">
                    <td class="cell-member">
                        <?=$currentCell->extendedLabel?>
                    </td>
                    <td>
                        <?php // Input ?>
                        <?php if ($currentCell->showInput) : ?>
                            <a class="go-input btn btn-link btn-sm withTooltip" href="orga/cell/input/idCell/<?=$currentCell->id?>/fromIdCell/<?=$currentCell->id?>/" title="<?=___('Orga', 'view', 'viewInput')?>">
                                <?=___('Orga', 'view', 'inputLinkDetail')?>
                            </a>
                            <span class="input-status withTooltip" title="<?=$currentCell->inputStatusTitle?>">
                                <i class="fa fa-<?=(($currentCell->inputStatus == Orga_Model_Cell::INPUT_STATUS_FINISHED) ? 'certificate' : (($currentCell->inputStatus == Orga_Model_Cell::INPUT_STATUS_COMPLETE) ? 'check-square-o' : (($currentCell->inputStatus == Orga_Model_Cell::INPUT_STATUS_CALCULATION_INCOMPLETE) ? 'warning' : (($currentCell->inputStatus == Orga_Model_Cell::INPUT_STATUS_INPUT_INCOMPLETE) ? 'pencil-square-o' : (($currentCell->inputStatus == Orga_Model_Cell::INPUT_STATUS_NOT_STARTED) ? 'square-o' : (($currentCell->inputStatus == Orga_Model_Cell::INPUT_STATUS_AF_NOT_CONFIGURED) ? 'wrench' : 'ban'))))))?> fa-fw"></i>
                            </span>
                        <?php endif; ?>
                        <?php // Inventory ?>
                        <?php if ($currentCell->showInventory) : ?>
                            <span class="inventory-status withTooltip" title="<?=$currentCell->inventoryStatusTitle?>">
                                <i class="fa fa-<?=(($currentCell->inventoryStatus == Orga_Model_Cell::INVENTORY_STATUS_CLOSED) ? 'lock' : ($currentCell->inventoryStatus == Orga_Model_Cell::INVENTORY_STATUS_ACTIVE) ? 'unlock-alt' : 'ban')?> fa-fw"></i>
                            </span>
                            <?php if ($currentCell->showInventoryProgress) : ?>
                                <div class="inventory-progress withPopover" title="<?=___('Orga', 'view', 'inventoryInputsDetails')?>" data-toggle="tooltip" data-placement="bottom" data-trigger="hover" data-html="true" data-content="<?=$currentCell->inventoryNotStartedInputsNumber?> <?=($currentCell->inventoryNotStartedInputsNumber > 1) ? ___('Orga', 'view', 'inputsNotStartedMany') : ___('Orga', 'view', 'inputsNotStartedSingle')?> <br> <?=$currentCell->inventoryStartedInputsNumber?> <?=($currentCell->inventoryStartedInputsNumber > 1) ? ___('Orga', 'view', 'inputsStartedMany') : ___('Orga', 'view', 'inputsStartedSingle')?> <br> <?=$currentCell->inventoryFinishedInputsNumber?> <?=($currentCell->inventoryFinishedInputsNumber > 1) ? ___('Orga', 'view', 'inputsCompletedMany') : ___('Orga', 'view', 'inputsCompletedSingle')?> <hr> <strong><?=(($currentCell->inventoryCompletion > 0) ? ($currentCell->inventoryCompletion + '% '.___('Orga', 'view', 'percentInputsCompleted')) : ___('Orga', 'view', 'noInputsCompleted'))?> </strong>" data-container="body">
                                    <div class="inventory-progress-bar" style="width: <?=$currentCell->inventoryCompletion?>%;"></div>
                                    <div class="inventory-completion">
                                        <?=$currentCell->inventoryCompletion?>%
                                    </div>
                                </div>
                            <?php endif; ?>
                            <?php if ($currentCell->canEditInventory) : ?>
                                <div class="inventory-actions btn-group">
                                    <a class="btn btn-default btn-sm change-inventory-status" href="orga/cell/edit-inventory-status/idCell/<?=$currentCell->id?>/inventoryStatus/<?=($currentCell->inventoryStatus === Orga_Model_Cell::INVENTORY_STATUS_ACTIVE) ? Orga_Model_Cell::INVENTORY_STATUS_CLOSED : Orga_Model_Cell::INVENTORY_STATUS_ACTIVE?>/">
                                        <?=($currentCell->inventoryStatus === Orga_Model_Cell::INVENTORY_STATUS_NOTLAUNCHED) ? ___('Orga', 'view', 'inventoryNotLaunchedMainAction') : (($currentCell->inventoryStatus == Orga_Model_Cell::INVENTORY_STATUS_ACTIVE) ? ___('Orga', 'view', 'inventoryActiveMainAction') : ___('Orga', 'view', 'inventoryClosedMainAction'))?>
                                    </a>
                                    <button class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
                                        <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="change-inventory-status" href="orga/cell/edit-inventory-status/idCell/<?=$currentCell->id?>/inventoryStatus/<?=($currentCell->inventoryStatus === Orga_Model_Cell::INVENTORY_STATUS_NOTLAUNCHED) ? Orga_Model_Cell::INVENTORY_STATUS_CLOSED : Orga_Model_Cell::INVENTORY_STATUS_NOTLAUNCHED?>/">
                                                <?=($currentCell->inventoryStatus === Orga_Model_Cell::INVENTORY_STATUS_NOTLAUNCHED) ? ___('Orga', 'view', 'inventoryNotLaunchedOtherAction') : (($currentCell->inventoryStatus == Orga_Model_Cell::INVENTORY_STATUS_ACTIVE) ? ___('Orga', 'view', 'inventoryActiveOtherAction') : ___('Orga', 'view', 'inventoryClosedOtherAction'))?>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            <?php endif; ?>
                            <a class="btn btn-default btn-sm withTooltip" data-toggle="modal" data-target="#inventoryUsers<?=$currentCell->id?>" href="orga/cell/view-inventory-users/idCell/<?=$currentCell->id?>/" title="<?=___('Orga', 'view', 'viewInventoryUsers')?>"><i class="fa fa-bullhorn fa-fw"></i></a>
                        <?php endif; ?>
                        <?php // Administrateurs ?>
                        <a class="btn btn-default btn-sm withTooltip" data-toggle="modal" href="#administrators<?=$currentCell->id?>" title="<?=___('Orga', 'view', 'contactAdministrators')?>" data-container="body"><i class="fa fa-life-ring fa-fw"></i></a>
                        <?php // Users ?>
                        <?php if ($currentCell->showUsers) : ?>
                        <a class="btn btn-default btn-sm withTooltip" data-toggle="modal" data-target="#users<?=$currentCell->id?>" href="orga/cell/view-users/idCell/<?=$currentCell->id?>/" title="<?=___('Orga', 'view', 'editUsers')?>" data-container="body">(<?=$currentCell->numberUsers?>) <i class="fa fa-users fa-fw"></i></a>
                        <?php endif; ?>
                        <?php // Reports ?>
                        <?php if ($currentCell->showReports) : ?>
                        <a class="btn btn-default btn-sm withTooltip" data-toggle="modal" data-target="#reports<?=$currentCell->id?>" href="orga/cell/view-reports/idCell/<?=$currentCell->id?>/" title="<?=___('Orga', 'view', 'analyzeData')?>" data-container="body"><i class="fa fa-bar-chart-o fa-fw"></i></a>
                        <a class="btn btn-default btn-sm withTooltip" data-toggle="modal" data-target="#exports<?=$currentCell->id?>" href="orga/cell/view-exports/idCell/<?=$currentCell->id?>/" title="<?=___('Orga', 'view', 'exportData')?>" data-container="body"><i class="fa fa-download fa-fw"></i></a>
                        <?php endif; ?>
                    </td>
                </tr>
            </table>

            <div id="administrators<?=$currentCell->id?>" class="modal administrators fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="withTooltip" title="<?=___('Orga', 'view', 'administratorExplanations')?>">
                                <?=___('Orga', 'view', 'administratorsFrom')?> <?=$currentCell->shortLabel?>
                                <i class="fa fa-question-circle fa-fw"></i>
                            </h4>
                        </div>
                        <div class="modal-body">
                            <pre><?=implode("\n", $currentCell->administrators)?></pre>
                        </div>
                    </div>
                </div>
            </div>
            <?php if ($currentCell->showUsers) : ?>
            <div id="users<?=$currentCell->id?>" class="modal modal-ajax users fade large" data-ajax="body">
                <div class="modal-dialog">
                    <div class="modal-content modal-lg">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4><?=___('Orga', 'view', 'rolesFrom')?> <?=$currentCell->shortLabel?></h4>
                        </div>
                        <div class="modal-body">
                            <div class="modal-loading">
                                <i class="fa fa-spinner fa-fw fa-spin fa-3x"></i>
                                <?=___('UI', 'loading', 'loading')?>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <form class="form-inline addUser" action="orga/cell/add-user/idCell/<?=$currentCell->id?>/">
                                <input type="text" name="userEmail" placeholder="<?=___('User', 'user', 'emailAddress')?>" class="form-control">
                                <select name="userRole" class="form-control">
                                    <option value="CellAdminRole"><?=CellAdminRole::getLabel()?></option>
                                    <option value="CellManagerRole"><?=CellManagerRole::getLabel()?></option>
                                    <option value="CellContributorRole"><?=CellContributorRole::getLabel()?></option>
                                    <option value="CellObserverRole"><?=CellObserverRole::getLabel()?></option>
                                </select>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-plus fa-fw"></i>
                                    <?=___('UI', 'verb', 'add')?>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <?php endif; ?>
            <?php if ($currentCell->showReports) : ?>
            <div id="reports<?=$currentCell->id?>" class="modal modal-ajax reports fade" data-ajax="body">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4><?=___('Orga', 'view', 'reportsFrom')?> <?=$currentCell->shortLabel?></h4>
                        </div>
                        <div class="modal-body">
                            <div class="modal-loading">
                                <i class="fa fa-spinner fa-fw fa-spin fa-3x"></i>
                                <?=___('UI', 'loading', 'loading')?>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a href="orga/cell/view-report/idCell/<?=$currentCell->id?>/" class="btn btn-primary">
                                <i class="fa fa-plus fa-fw"></i>
                                <?=___('UI', 'verb', 'add')?>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <?php endif; ?>
            <div id="exports<?=$currentCell->id?>" class="modal modal-ajax exports fade" data-ajax="body">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4><?=___('Orga', 'view', 'exportsFrom')?> <?=$currentCell->shortLabel?></h4>
                        </div>
                        <div class="modal-body">
                            <div class="modal-loading">
                                <i class="fa fa-spinner fa-fw fa-spin fa-3x"></i>
                                <?=___('UI', 'loading', 'loading')?>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php if ($currentCell->showInventory) : ?>
            <div id="inventoryUsers<?=$currentCell->id?>" class="modal modal-ajax inventory-users fade" data-ajax="body">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="withTooltip" title="<?=___('Orga', 'view', 'inventoryUsersExplanations')?>">
                                <?=___('Orga', 'view', 'inventoryUsersFrom')?> <?=$currentCell->shortLabel?>
                                <i class="fa fa-question-circle fa-fw"></i>
                            </h4>
                        </div>
                        <div class="modal-body">
                            <div class="modal-loading">
                                <i class="fa fa-spinner fa-fw fa-spin fa-3x"></i>
                                <?=___('UI', 'loading', 'loading')?>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <?php endif; ?>
        </div>
    </fieldset>

    <?php foreach ($this->narrowerGranularities as $narrowerGranularityArray) :
    /** @var Orga_Model_Granularity $narrowerGranularity */
    $narrowerGranularity = $narrowerGranularityArray['granularity'];
    ?>
    <fieldset class="collapse-wrapper granularity-wrapper">
        <legend data-closed-indicator="<i class=&quot;fa fa-chevron-right fa-fw&quot;></i>" data-opened-indicator="<i class=&quot;fa fa-chevron-down fa-fw&quot;></i>">
            <a data-toggle="collapse" href="#granularity<?=$narrowerGranularity->getId()?>">
                <i class="fa fa-chevron-<?=(count($this->narrowerGranularities) === 1) ? 'down': $narrowerGranularityArray['isInput'] ? 'down' : 'right'?> fa-fw"></i>
                <?=$this->translate($narrowerGranularity->getLabel())?>
                <small>
                    <i>
                        <?=___('Orga', 'view', 'granularityExplanations')?><?=$narrowerGranularityArray['purpose']?>
                    </i>
                </small>
            </a>
        </legend>

        <div id="granularity<?=$narrowerGranularity->getId()?>"
             <?=$narrowerGranularityArray['isAcl'] ? ' data-acl' : ''?>
             <?=($narrowerGranularityArray['isInventory'] || $narrowerGranularityArray['isInput']) ? ' data-inventory' : ''?>
             <?=$narrowerGranularityArray['isInput'] ? ' data-input' : ''?>
             <?=$narrowerGranularityArray['isAnalyses'] ? ' data-analyses' : ''?>
             data-total-cells="<?=$narrowerGranularityArray['totalCells']?>"
             data-first-cell="<?=$defaultDataFirstCell?>"
             class="collapse<?=(count($this->narrowerGranularities) === 1) ? ' in': $narrowerGranularityArray['isInput'] ? ' in' : ''?>"
             <?=(count($this->narrowerGranularities) === 1) ? ' ': $narrowerGranularityArray['isInput'] ? ' ' : ''?>">
            <?php if ($narrowerGranularity->hasAxes() || ($narrowerGranularity->getInputConfigGranularity() !== null)) : ?>
            <form class="form-inline cells-filter">
                <?php foreach ($narrowerGranularityArray['filterAxes'] as $refAxis => $memberOptions) : ?>
                    <?php if (count($memberOptions) > 2) : ?>
                        <select name="granularity<?=$narrowerGranularity->getId()?>_axis<?=$refAxis?>" data-filter="tag" class="form-control input-sm">
                            <?php foreach ($memberOptions as $memberTag => $memberLabel) : ?>
                                <option value="<?=$memberTag?>"><?=$memberLabel?></option>
                            <?php endforeach; ?>
                        </select>
                    <?php endif; ?>
                <?php endforeach; ?>
                <?php if ($narrowerGranularityArray['isInventory'] || $narrowerGranularityArray['showInventory']) : ?>
                <select name="granularity<?=$narrowerGranularity->getId()?>_inventoryStatus" data-filter="inventory-status" class="form-control input-sm">
                    <?php foreach ($inventoryStatusFilters as $statusValue => $statusLabel) : ?>
                        <?php if (($statusValue === Orga_Model_Cell::INVENTORY_STATUS_ACTIVE) && (!$narrowerGranularityArray['isGranularityForInventoryStatus'])) : ?>
                            <option value="<?=$statusValue?>" selected><?=$statusLabel?></option>
                        <?php else: ?>
                            <option value="<?=$statusValue?>"><?=$statusLabel?></option>
                        <?php endif ?>
                    <?php endforeach ?>
                </select>
                <?php endif; ?>
                <?php if ($narrowerGranularityArray['isInput']) : ?>
                <select name="granularity<?=$narrowerGranularity->getId()?>_inputStatus" data-filter="input-status" class="form-control input-sm">
                    <?php foreach ($inputStatusFilters as $statusValue => $statusLabel) : ?>
                        <option value="<?=$statusValue?>"><?=$statusLabel?></option>
                    <?php endforeach ?>
                </select>
                <?php endif; ?>
                <button class="btn btn-default btn-sm reset"><i class="fa fa-search-minus fa-fw"></i> <?=___('UI', 'verb', 'reset')?></button>
                <select name="show-cells" class="form-control input-sm withTooltip" title="<?=___('UI', 'datagridPagination', 'lineNumber')?>">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <span class="badge badge-info granularity-info withTooltip" title="<?=___('Orga', 'view', 'ratioNumberFilteredCellsOverTotal')?>" data-toggle="tooltip" data-placement="right" data-trigger="hover"></span>
            </form>
            <?php endif; ?>

            <table class="granularity table table-condensed table-hover" data-filtered-cells="0"></table>
        </div>
    </fieldset>
    <?php endforeach; ?>

</div>

<div class="col-md-3">
    <div class="comments">
        <h3>
            <?=___('Orga', 'comment', 'comments')?>
            <small class="pull-right">
                <a href="orga/cell/view-comments/idCell/<?=$currentCell->id?>/" class="refresh">
                    <i class="fa fa-refresh fa-fw"></i>
                </a>
            </small>
        </h3>
        <div>
            <?=___('UI', 'loading', 'error')?>
        </div>
    </div>
    <div class="history">
        <h3>
            <?=___('UI', 'history', 'history')?>
            <small class="pull-right">
                <a href="orga/cell/view-history/idCell/<?=$currentCell->id?>/" class="refresh">
                    <i class="fa fa-refresh fa-fw"></i>
                </a>
            </small>
        </h3>
        <div>
            <?=___('UI', 'loading', 'error')?>
        </div>
    </div>
    <?php if ($this->canAddMembers) : ?>
    <div class="addMember">
        <h3>
            <div class="pull-right">
                <small>
                    <a class="editOrganization btn btn-sm btn-default"
                       href="orga/organization/edit/idOrganization/<?=$organization->id?>/tab/members/">
                        <i class="fa fa-wrench fa-fw"></i>
                        <?=___('UI', 'name', 'configurationOrga')?>
                    </a>
                </small>
            </div>
            <?=___('Orga', 'view', 'addMember')?>
        </h3>
        <?=$this->addMemberForm->display()?>
    </div>
    <?php endif; ?>
</div>

</div>
<script>
$('.comments a.refresh').on('click', function(e) {
    e.preventDefault();
    $('.comments > h3 i').addClass('fa-spin');
    $('.comments > div').html('<i class="fa fa-spinner fa-fw fa-spin fa-3x"></i> <?=addslashes(___('Orga', 'comment', 'loadingComments'))?>');
    $.ajax({
        url: $(this).attr('href'),
        type: "GET",
        success: function(data) {
            $('.comments > h3 i').removeClass('fa-spin');
            $('.comments > div').html('');
            if (data.length > 0) {
                $.each(data, function() {
                    var date = this.date;
                    $('.comments > div').append('<div data-date="' + date + '"><h4><span>' + date + '</span></h4></div>');
                    var divDate = $('.comments > div > div[data-date="' + date + '"]');
                    $.each(this.comments, function() {
                        divDate.append(
                            '<div class="row">' +
                                '<div class="col-md-2">' + this.time + '</div>' +
                                '<div class="col-md-10">' + this.comment + '</div>' +
                            '</div>'
                        );
                    });
                });
            } else {
                $('.comments > div').html('<p><?=addslashes(___('Orga', 'comment', 'noComment'))?></p>');
            }
        },
        error: function(jqXHR) {
            $('.comments > h3 i').removeClass('fa-spin');
            $('.comments > div').html('<?=addslashes(___('Orga', 'comment', 'errorWhileLoadingComments'))?>');
        }
    });
});
$('.history a.refresh').on('click', function(e) {
    e.preventDefault();
    $('.history > h3 i').addClass('fa-spin');
    $('.history > div').html('<i class="fa fa-spinner fa-fw fa-spin fa-3x"></i> <?=addslashes(___('UI', 'history', 'loadingHistory'))?>');
    $.ajax({
        url: $(this).attr('href'),
        type: "GET",
        success: function(data) {
            $('.history > h3 i').removeClass('fa-spin');
            $('.history > div').html('');
            if (data.length > 0) {
                $.each(data, function() {
                    var date = this.date;
                    $('.history > div').append('<div data-date="' + date + '"><h4><span>' + date + '</span></h4></div>');
                    var divDate = $('.history > div > div[data-date="' + date + '"]');
                    $.each(this.events, function() {
                        divDate.append(
                            '<div class="row">' +
                                '<div class="col-md-2">' + this.time + '</div>' +
                                '<div class="col-md-10">' + this.event + '</div>' +
                            '</div>'
                        );
                    });
                });
            } else {
                $('.history > div').html('<p><?=___('UI', 'history', 'noHistory')?></p>');
            }
        },
        error: function(jqXHR) {
            $('.history > h3 i').removeClass('fa-spin');
            $('.history > div').html('<?=addslashes(___('UI', 'loading', 'error'))?>');
        }
    });
});

$('div.collapse[id^="granularity"]').on('loadCells', function(e) {
    if (e.target != this) {
        return;
    }
    var granularity = $('.granularity', $(this));
    var granularityInfo = $('.granularity-info', granularity.closest('.collapse'));
    granularityInfo[0].className = granularityInfo[0].className.replace(/\bbadge-.*?\b/g, '');
    granularityInfo.addClass('badge-info');
    granularityInfo.html('<i class="fa fa-spinner fa-fw fa-spin"></i> <?=___('UI', 'loading', 'loading')?>');
    granularity.append(
        '<tr class="loading-cells">' +
            '<td colspan="100%">' +
                '<i class="fa fa-spinner fa-fw fa-spin"></i> ' +
                '<?=___('UI', 'loading', 'loading')?>' +
            '</td>' +
        '</tr>'
    );
    var granularityId = $(this).attr('id').substr(11, $(this).attr('id').length);
    $.ajax({
        url: 'orga/cell/view-children/idCell/<?=$currentCell->id?>/idGranularity/' + granularityId + '/',
        type: "POST",
        data: { firstCell: $(this).attr('data-first-cell'), showCells: $('.cells-filter :input[name="show-cells"]', $(this)).val(), filters: $('.cells-filter :input[name!="show-cells"]', $(this)).serializeArray() },
        success: function(data) {
            granularity.attr('data-filtered-cells', data.totalCells);
            granularityInfo.html(granularity.attr('data-filtered-cells') + ' / ' + granularity.parent().attr('data-total-cells'));
            $(data.childCells).each(function() {
                var cellTitle = '';
                for (var refAxis in this.members) {
                    if ($.inArray(refAxis, <?=json_encode($this->refAxes)?>) < 0){
                        cellTitle += '<td class="cell-member">' + this.members[refAxis] + '</td>';
                    }
                }
                var usersP = '';
                var usersPopup = '';
                if (this.showUsers) {
                    usersP +=
                        '<a class="show-users btn btn-default btn-sm withTooltip" data-toggle="modal" data-target="#users' + this.id + '" href="orga/cell/view-users/idCell/' + this.id + '/" title="<?=___('Orga', 'view', 'editUsers')?>" data-container="body">' +
                            '(' + this.numberUsers + ') ' +
                            '<i class="fa fa-users fa-fw"></i>' +
                        '</a>';
                    usersPopup +=
                        '<div id="users' + this.id + '" class="modal modal-ajax users fade large" data-ajax="body">' +
                            '<div class="modal-dialog modal-lg">' +
                                '<div class="modal-content">' +
                                    '<div class="modal-header">' +
                                        '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                                        '<h4><?=___('Orga', 'view', 'rolesFrom')?> ' + this.shortLabel + '</h4>' +
                                    '</div>' +
                                    '<div class="modal-body">' +
                                        '<div class="modal-loading">' +
                                            '<i class="fa fa-spinner fa-fw fa-spin fa-3x"></i>' +
                                            '<?=___('UI', 'loading', 'loading')?>' +
                                        '</div>' +
                                    '</div>' +
                                    '<div class="modal-footer">' +
                                        '<form class="form-inline addUser" action="orga/cell/add-user/idCell/' + this.id + '/">' +
                                            '<input type="text" placeholder="<?=___('User', 'user', 'emailAddress')?>" name="userEmail" class="form-control"> ' +
                                            '<select name="userRole" class="form-control">' +
                                                '<option value="CellAdminRole"><?=CellAdminRole::getLabel()?></option>' +
                                                '<option value="CellManagerRole"><?=CellManagerRole::getLabel()?></option>' +
                                                '<option value="CellContributorRole"><?=CellContributorRole::getLabel()?></option>' +
                                                '<option value="CellObserverRole"><?=CellObserverRole::getLabel()?></option>' +
                                            '</select> ' +
                                            '<input type="submit" class="btn btn-primary" value="<?=___('UI', 'verb', 'add')?>"> ' +
                                        '</form>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                }
                var reportsP = '';
                var reportsPopup = '';
                if (this.showReports) {
                    reportsP +=
                        '<a class="show-reports btn btn-default btn-sm withTooltip" data-toggle="modal" data-target="#reports' + this.id + '" href="orga/cell/view-reports/idCell/' + this.id + '/fromIdCell/<?=$currentCell->id?>/" title="<?=___('Orga', 'view', 'analyzeData')?>" data-container="body">' +
                            '<i class="fa fa-bar-chart-o fa-fw"></i>' +
                        '</a>';
                    reportsPopup +=
                        '<div id="reports' + this.id + '" class="modal modal-ajax reports fade large" data-ajax="body">' +
                            '<div class="modal-dialog modal-lg">' +
                                '<div class="modal-content">' +
                                    '<div class="modal-header">' +
                                        '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                                        '<h4><?=___('Orga', 'view', 'reportsFrom')?>' + this.shortLabel + '</h4>' +
                                    '</div>' +
                                    '<div class="modal-body">' +
                                        '<div class="modal-loading">' +
                                            '<i class="fa fa-spinner fa-fw fa-spin fa-3x"></i>' +
                                            '<?=___('UI', 'loading', 'loading')?>' +
                                        '</div>' +
                                    '</div>' +
                                    '<div class="modal-footer">' +
                                        '<a href="orga/cell/view-report/idCell/' + this.id + '/fromIdCell/<?=$currentCell->id?>/" class="btn btn-primary">' +
                                            '<i class="fa fa-plus fa-fw"></i> ' +
                                            '<?=___('UI', 'verb', 'add')?>' +
                                        '</a>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                }
                var exportsP = '';
                var exportsPopup = '';
                if (this.showExports) {
                    exportsP +=
                        '<a class="show-exports btn btn-default btn-sm withTooltip" data-toggle="modal" data-target="#exports' + this.id + '" href="orga/cell/view-exports/idCell/' + this.id + '/" title="<?=___('Orga', 'view', 'exportData')?>" data-container="body">' +
                            '<i class="fa fa-download fa-fw"></i>' +
                        '</a>';
                    exportsPopup +=
                        '<div id="exports' + this.id + '" class="modal modal-ajax exports fade" data-ajax="body">' +
                            '<div class="modal-dialog">' +
                                '<div class="modal-content">' +
                                    '<div class="modal-header">' +
                                        '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                                        '<h4><?=___('Orga', 'view', 'exportsFrom')?> ' + this.shortLabel + '</h4>' +
                                    '</div>' +
                                    '<div class="modal-body">' +
                                        '<div class="modal-loading">' +
                                            '<i class="fa fa-spinner fa-fw fa-spin fa-3x"></i> ' +
                                            '<?=___('UI', 'loading', 'loading')?>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                }
                var inventoryP = '';
                var inventoryPopup = '';
                if (this.showInventory) {
                    var inventoryStatusIcon = (this.inventoryStatus == '<?=Orga_Model_Cell::INVENTORY_STATUS_CLOSED?>') ? 'lock' : (this.inventoryStatus == '<?=Orga_Model_Cell::INVENTORY_STATUS_ACTIVE?>') ? 'unlock-alt' : 'ban';
                    inventoryP +=
                        '<span class="inventory-status withTooltip" title="' + this.inventoryStatusTitle + '">' +
                            '<i class="fa fa-' + inventoryStatusIcon + ' fa-fw"></i>' +
                        '</span>';
                    if (this.showInventoryProgress) {
                        inventoryP +=
                            '<div class="inventory-progress withPopover" title="<?=___('Orga', 'view', 'inventoryInputsDetails')?>"' +
                                'data-toggle="tooltip" data-placement="bottom" data-trigger="hover" data-container="body" data-html="true"' +
                                'data-content="' +
                                this.inventoryNotStartedInputsNumber + ' ' +
                                ((this.inventoryNotStartedInputsNumber > 1) ? '<?=___('Orga', 'view', 'inputsNotStartedMany')?>' : '<?=___('Orga', 'view', 'inputsNotStartedSingle')?>') +
                                ' <br> ' +
                                this.inventoryStartedInputsNumber + ' ' +
                                ((this.inventoryStartedInputsNumber > 1) ? '<?=___('Orga', 'view', 'inputsStartedMany')?>' : '<?=___('Orga', 'view', 'inputsStartedSingle')?>') +
                                ' <br> ' +
                                this.inventoryFinishedInputsNumber + ' ' +
                                ((this.inventoryFinishedInputsNumber > 1) ? '<?=___('Orga', 'view', 'inputsCompletedMany')?>' : '<?=___('Orga', 'view', 'inputsCompletedSingle')?>') +
                                ' <hr> ' +
                                ' <strong> ' +
                                ((this.inventoryCompletion > 0) ? (this.inventoryCompletion + '% <?=___('Orga', 'view', 'percentInputsCompleted')?>') : '<?=___('Orga', 'view', 'noInputsCompleted')?>') +
                                ' </strong> ' +
                                '">' +
                                '<div class="inventory-progress-bar" style="width: ' + this.inventoryCompletion + '%;">' +
                                '</div>' +
                                '<div class="inventory-completion">' +
                                    this.inventoryCompletion + '% ' +
                                '</div>' +
                            '</div> ';
                    }
                    if (this.canEditInventory) {
                        var mainActionStatus = (this.inventoryStatus == '<?=Orga_Model_Cell::INVENTORY_STATUS_ACTIVE?>') ? '<?=Orga_Model_Cell::INVENTORY_STATUS_CLOSED?>' : '<?=Orga_Model_Cell::INVENTORY_STATUS_ACTIVE?>';
                        var mainActionLabel = (this.inventoryStatus == '<?=Orga_Model_Cell::INVENTORY_STATUS_NOTLAUNCHED?>') ? '<?=___('Orga', 'view', 'inventoryNotLaunchedMainAction')?>' : (this.inventoryStatus == '<?=Orga_Model_Cell::INVENTORY_STATUS_ACTIVE?>') ? '<?=___('Orga', 'view', 'inventoryActiveMainAction')?>' : '<?=___('Orga', 'view', 'inventoryClosedMainAction')?>';
                        var otherActionStatus = (this.inventoryStatus == '<?=Orga_Model_Cell::INVENTORY_STATUS_NOTLAUNCHED?>') ? '<?=Orga_Model_Cell::INVENTORY_STATUS_CLOSED?>' : '<?=Orga_Model_Cell::INVENTORY_STATUS_NOTLAUNCHED?>';
                        var otherActionLabel = (this.inventoryStatus == '<?=Orga_Model_Cell::INVENTORY_STATUS_NOTLAUNCHED?>') ? '<?=___('Orga', 'view', 'inventoryNotLaunchedOtherAction')?>' : (this.inventoryStatus == '<?=Orga_Model_Cell::INVENTORY_STATUS_ACTIVE?>') ? '<?=___('Orga', 'view', 'inventoryActiveOtherAction')?>' : '<?=___('Orga', 'view', 'inventoryClosedOtherAction')?>';
                        inventoryP +=
                            '<div class="btn-group inventory-actions">' +
                                '<a class="btn btn-default btn-sm change-inventory-status" href="orga/cell/edit-inventory-status/idCell/' + this.id + '/inventoryStatus/' + mainActionStatus + '/">' +
                                    mainActionLabel +
                                '</a>' +
                                '<button class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">' +
                                    '<span class="caret"></span>' +
                                '</button>' +
                                '<ul class="dropdown-menu">' +
                                    '<li>' +
                                        '<a class="change-inventory-status" href="orga/cell/edit-inventory-status/idCell/' + this.id + '/inventoryStatus/' + otherActionStatus + '/">' +
                                            otherActionLabel +
                                        '</a>' +
                                    '</li>' +
                                '</ul>' +
                            '</div>';
                    }
                    inventoryP +=
                        '<a class="show-inventory-users btn btn-default btn-sm withTooltip" data-toggle="modal" data-target="#inventoryUsers' + this.id + '" href=orga/cell/view-inventory-users/idCell/' + this.id + '/" title="<?=___('Orga', 'view', 'viewInventoryUsers')?>">' +
                            '<i class="fa fa-bullhorn fa-fw"></i>' +
                        '</a>';
                    inventoryPopup +=
                        '<div id="inventoryUsers' + this.id + '" class="modal modal-ajax inventory-users fade" data-ajax="body">' +
                            '<div class="modal-dialog">' +
                                '<div class="modal-content">' +
                                    '<div class="modal-header">' +
                                        '<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>' +
                                        '<h4 class="withTooltip" title="<?=___('Orga', 'view', 'inventoryUsersExplanations')?>">' +
                                            '<?=___('Orga', 'view', 'inventoryUsersFrom')?>' + this.shortLabel + ' ' +
                                            '<i class="fa fa-question-circle fa-fw"></i>' +
                                        '</h4>' +
                                    '</div>' +
                                    '<div class="modal-body">' +
                                        '<div class="modal-loading">' +
                                            '<i class="fa fa-spinner fa-fw fa-spin fa-3x"></i>' +
                                            '<?=___('UI', 'loading', 'loading')?>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                }
                var inputStatusP = '';
                if (this.showInput) {
                    var inputStatusIcon = (this.inputStatus == '<?=Orga_Model_Cell::INPUT_STATUS_FINISHED?>') ? 'certificate' : (this.inputStatus == '<?=Orga_Model_Cell::INPUT_STATUS_COMPLETE?>') ? 'check-square-o' : (this.inputStatus == '<?=Orga_Model_Cell::INPUT_STATUS_CALCULATION_INCOMPLETE?>') ? 'warning' : (this.inputStatus == '<?=Orga_Model_Cell::INPUT_STATUS_INPUT_INCOMPLETE?>') ? 'pencil-square-o' : (this.inputStatus == '<?=Orga_Model_Cell::INPUT_STATUS_NOT_STARTED?>') ? 'square-o' : (this.inputStatus == '<?=Orga_Model_Cell::INPUT_STATUS_AF_NOT_CONFIGURED?>') ? 'wrench' : 'ban';
                    inputStatusP +=
                        '<a class="go-input btn btn-link btn-sm withTooltip' + (((this.inventoryStatus != '<?=Orga_Model_Cell::INVENTORY_STATUS_NOTLAUNCHED?>') && (this.inputStatus != '<?=Orga_Model_Cell::INPUT_STATUS_AF_NOT_CONFIGURED?>')) ? '' : ' disabled') + '" href="orga/cell/input/idCell/' + this.id + '/fromIdCell/<?=$currentCell->id?>/" title="<?=___('Orga', 'view', 'viewInput')?>">' +
                            '<?=___('Orga', 'view', 'inputLinkDetail')?>' +
                        '</a>' +
                        '<span class="input-status withTooltip" title="' + this.inputStatusTitle + '">' +
                            '<i class="fa fa-' + inputStatusIcon + ' fa-fw"></i>' +
                        '</span>';
                }
                granularity.append(
                    '<tr class="cell" data-tag="' + this.tag + '" data-input-status="' + this.inputStatus + '" data-inventory-status="' + this.inventoryStatus + '">' +
                        cellTitle +
                        '<td>'+
                            inputStatusP +
                            inventoryP +
                            reportsP +
                            usersP +
                            exportsP +
                        '</td>'+
                    '</tr>'
                );
                granularity.after(usersPopup)
                granularity.after(reportsPopup)
                granularity.after(exportsPopup)
                granularity.after(inventoryPopup)
            });
            $('.withTooltip', granularity).tooltip();
            $('.withPopover', granularity).popover();
            $(granularity.closest('.collapse')).trigger('showCells');
        },
        error: function(jqXHR) {
            granularityInfo[0].className = granularityInfo[0].className.replace(/\bbadge-.*?\b/g, '');
            var response = $.parseJSON(jqXHR.responseText);
            if (typeof(response.typeError) == 'string') {
                granularityInfo.addClass('badge-' + response.typeError);
            } else {
                granularityInfo.addClass('badge-error');
            }
            if (typeof(response.message) == 'string') {
                granularityInfo.html(response.message);
            } else {
                granularityInfo.html('<?=___('UI', 'loading', 'error')?>');
            }
        },
        complete: function(jqXHR) {
            $('.loading-cells', granularity).remove();
        }
    });
});

$('.cells-filter button.reset').on('click', function(e) {
    e.preventDefault();
    var form = $(this).closest('form');
    form.trigger('resetCellsFilter');
});
$('.cells-filter select').on('keyup change', function(e) {
    var collapse = $(this).closest('.collapse');
    collapse.attr('data-first-cell', <?=$defaultDataFirstCell?>);
    $('.granularity', collapse).html('');
    collapse.trigger('loadCells');
});
$('.cells-filter').on('resetCellsFilter', function(e) {
    e.preventDefault();
    $('select[name!="show-cells"]', $(this)).val('');
    var collapse = $(this).closest('.collapse');
    collapse.attr('data-first-cell', <?=$defaultDataFirstCell?>);
    $('.granularity', collapse).html('');
    collapse.trigger('loadCells');
});
$('div.collapse[id^="granularity"]').on('showCells', function(e) {
    var granularity = $('.granularity', $(this));
    $('.change-cells-display', granularity).remove();

    if (granularity.attr('data-filtered-cells') == '0') {
        granularity.append('<tr class="no-cell"><td colspan="100%"><?=___('Orga', 'view', 'filterNoResult')?></td></tr>');
    } else {
        var firstLineDisplayed = $(this).attr('data-first-cell') * 1;
        var linesDisplayed = $(':input[name="show-cells"]', this).val() * 1;
        if ((firstLineDisplayed > 0) || ((firstLineDisplayed + linesDisplayed) < granularity.attr('data-filtered-cells'))) {
            granularity.prepend('<tr class="change-cells-display"><td colspan="100%"></td></tr>');
            granularity.append('<tr class="change-cells-display"><td colspan="100%"></td></tr>');
            if (firstLineDisplayed > 0) {
                $('.change-cells-display td', $(this)).append(
                    '<button class="btn btn-default btn-xs display-prev-cells withTooltip" title="<?=___('Orga', 'view', 'displayPrevCells')?>" data-placement="left">' +
                        '<i class="fa fa-angle-double-left fa-fw"></i>' +
                    '</button> '
                );
            }
            $('.change-cells-display td', $(this)).append(
                ($(this).attr('data-first-cell') * 1 + 1) +
                ' - ' +
                (((firstLineDisplayed + linesDisplayed) < granularity.attr('data-filtered-cells'))
                    ? (firstLineDisplayed + linesDisplayed) : granularity.attr('data-filtered-cells')) +
                ' / ' +
                granularity.attr('data-filtered-cells')
            );
            if ((firstLineDisplayed + linesDisplayed) < granularity.attr('data-filtered-cells')) {
                $('.change-cells-display td', $(this)).append(
                    ' <button class="btn btn-default btn-xs display-next-cells withTooltip" title="<?=___('Orga', 'view', 'displayNextCells')?>" data-placement="right">' +
                        '<i class="fa fa-angle-double-right fa-fw"></i>' +
                    '</button>'
                );
            }
            $('.change-cells-display td .withTooltip', $(this)).tooltip();
        }
    }
});
$('body').on('click', '.display-next-cells', function (e) {
    var granularity = $(this).closest('.granularity');
    granularity.closest('.collapse').attr(
        'data-first-cell',
        (granularity.closest('.collapse').attr('data-first-cell') * 1 + $(':input[name="show-cells"]', granularity.closest('.collapse')).val() * 1)
    );
    granularity.html('');
    granularity.closest('.collapse').trigger('loadCells');
});
$('body').on('click', '.display-prev-cells', function (e) {
    var granularity = $(this).closest('.granularity');
    granularity.closest('.collapse').attr(
        'data-first-cell',
        (granularity.closest('.collapse').attr('data-first-cell') * 1 - $(':input[name="show-cells"]', granularity.closest('.collapse')).val() * 1)
    );
    granularity.html('');
    granularity.closest('.collapse').trigger('loadCells');
});

$('body').on('click', '.delete-user', function(e) {
    e.preventDefault();
    if ($(this).attr('data-submitting') === 'true') {
        return false;
    }
    $('.user-message').remove();
    $(this).closest('tr').after(
        '<tr class="info user-message">' +
            '<td colspan="5">' +
                '<?=___('Orga', 'view', 'askConfirmDeleteUser')?>' +
                $(this).closest('td').prev().prev().html() +
                '<button class="btn btn-primary confirm"><i class="fa fa-check fa-fw"></i> <?=___('UI', 'verb', 'confirm')?></button>' +
                '<button class="btn btn-default close-user-message"><i class="fa fa-times"></i> <?=___('UI', 'verb', 'cancel')?></button>' +
            '</td>' +
        '</tr>'
    );
});
$('body').on('click', 'tr.user-message .confirm', function(e) {
    e.preventDefault();
    var row = $(this).closest('tr');
    var deleteUser = $('.delete-user', row.prev());
    if (deleteUser.attr('data-submitting') === 'true') {
        return false;
    }
    deleteUser.attr('data-submitting', true);
    row.html('<td colspan="5"><i class="fa fa-spinner fa-fw fa-spin"></i></td>');
    $.ajax({
        url: $('a.delete-user', row.prev()).attr('href'),
        type: "POST",
        success: function(data) {
            row.prev().remove();
            row.removeClass('info');
            row.addClass('success');
            row.html(
                '<td colspan="4">' + data + '</td>' +
                '<td><button class="close close-user-message"><i class="fa fa-times"></i></button></td>'
            );
        },
        error: function(jqXHR) {
            deleteUser.attr('data-submitting', false);
            row.removeClass('info');
            var response = $.parseJSON(jqXHR.responseText);
            if (typeof(response.typeError) == 'string') {
                row.addClass(response.typeError);
            } else {
                row.addClass('error');
            }
            if (typeof(response.message) == 'string') {
                row.html(
                    '<td colspan="4">' + response.message + '</td>' +
                    '<td><button class="close close-user-message"><i class="fa fa-times"></i></button></td>'
                );
            } else {
                row.html(
                    '<td colspan="4"><?=___('Core', 'exception', 'applicationError')?></td>' +
                    '<td><button class="close close-user-message"><i class="fa fa-times"></i></button></td>'
                );
            }
        }
    });
});
$('body').on('click', 'tr.user-message .close-user-message', function(e) {
    e.preventDefault();
    $(this).closest('tr').remove();
});
$('body').on('submit', '.addUser', function(e) {
    e.preventDefault();
    var form = $(this);
    if (form.attr('data-submitting') === 'true') {
        return false;
    }
    form.attr('data-submitting', true);
    $('.user-message').remove();
    form.before('<div class="user-message alert alert-info"><i class="fa fa-spinner fa-fw fa-spin"></i></div>')
    $.ajax({
        url: form.attr('action'),
        type: "POST",
        data: form.serialize(),
        success: function(data) {
            form.prev().removeClass('alert-info');
            form.prev().addClass('alert-success');
            form.prev().html(data);
            form.closest('.modal').trigger(
                'loadModal.muih',
                'orga/cell/view-users/idCell/' + form.attr('action').match(/.*\/(\d+)\/$/)[1] + '/'
            );
            form.attr('data-submitting', false);
        },
        error: function(jqXHR) {
            form.prev().removeClass('alert-info');
            var response = $.parseJSON(jqXHR.responseText);
            if (typeof(response.typeError) == 'string') {
                form.prev().addClass('alert-' + response.typeError);
            } else {
                form.prev().addClass('alert-danger');
            }
            if (typeof(response.message) == 'string') {
                form.prev().html(response.message);
            } else {
                form.prev().html('<?=___('Core', 'exception', 'applicationError')?>');
            }
            form.attr('data-submitting', false);
        }
    });
});

$('body').on('hidden', '.reports', function(e) {
    if (e.target != this) {
        return;
    }
    var popup = $(this);
    $('.report-message', popup).remove();
});
$('body').on('click', '.delete-report', function(e) {
    e.preventDefault();
    if ($(this).attr('data-submitting') === 'true') {
        return false;
    }
    $('.report-message').remove();
    $(this).closest('tr').after(
        '<tr class="info report-message">' +
            '<td colspan="3">' +
                '<?=___('Orga', 'view', 'askConfirmDeleteReport')?>' +
                $('a', $(this).closest('td').prev().prev()).html() +
                '<button class="btn btn-primary confirm"><i class="fa fa-check fa-fw"></i> <?=___('UI', 'verb', 'confirm')?></button>' +
                '<button class="btn btn-default close-report-message"><i class="fa fa-times"></i> <?=___('UI', 'verb', 'cancel')?></button>' +
            '</td>' +
        '</tr>'
    );
});
$('body').on('click', 'tr.report-message .confirm', function(e) {
    e.preventDefault();
    var row = $(this).closest('tr');
    var deleteReport = $('.delete-report', row.prev());
    if (deleteReport.attr('data-submitting') === 'true') {
        return false;
    }
    deleteReport.attr('data-submitting', true);
    row.html('<td colspan="3"><i class="fa fa-spinner fa-fw fa-spin"></i></td>');
    $.ajax({
        url: $('a.delete-report', row.prev()).attr('href'),
        type: "POST",
        success: function(data) {
            row.prev().remove();
            row.removeClass('info');
            row.addClass('success');
            row.html(
                '<td colspan="2">' + data + '</td>' +
                '<td><button class="close close-report-message"><i class="fa fa-times"></i></button></td>'
            );
        },
        error: function(jqXHR) {
            deleteReport.attr('data-submitting', false);
            row.removeClass('info');
            var response = $.parseJSON(jqXHR.responseText);
            if (typeof(response.typeError) == 'string') {
                row.addClass(response.typeError);
            } else {
                row.addClass('error');
            }
            if (typeof(response.message) == 'string') {
                row.html(
                    '<td colspan="2">' + response.message + '</td>' +
                    '<td><button class="close close-report-message"><i class="fa fa-times"></i></button></td>'
                );
            } else {
                row.html(
                    '<td colspan="2"><?=___('Core', 'exception', 'applicationError')?></td>' +
                    '<td><button class="close close-report-message"><i class="fa fa-times"></i></button></td>'
                );
            }
        }
    });
});
$('body').on('click', 'tr.report-message .close-report-message', function(e) {
    e.preventDefault();
    $(this).closest('tr').remove();
});
$('body').on('keyup change', 'select[name="reportType"]', function(e) {
    var select = $(this);
    var reportsList = $('tbody', select.closest('table'));
    $('tr', reportsList).addClass('hide');

    var selectValue = select.val();
    var selector = '';
    if (selectValue != '') {
        selector += '[data-report-type="' + select.val() + '"]';
        if (selectValue == 'userReport') {
            selector += '[data-report-owner="' + select.find(":selected").attr('data-user') + '"]';
        }
    }
    $('tr' + selector, reportsList).removeClass('hide');
});

$('body').on('click', '.inventory-actions a.change-inventory-status', function(e) {
    e.preventDefault();
    var link = $(this);
    var buttonGroup = link.closest('.btn-group');
    var mainButton = $('> a.change-inventory-status', buttonGroup);
    var otherButton = $('> ul li a.change-inventory-status', buttonGroup);
    $('.inventory-status-message', buttonGroup).remove();
    buttonGroup.prepend('<button class="btn btn-default inventory-status-message"></button>');
    var loadingButton = $('.inventory-status-message', buttonGroup);
    loadingButton.html('<i class="fa fa-spinner fa-fw fa-spin"></i>');
    mainButton.addClass('hide');
    $('> button.dropdown-toggle', buttonGroup).addClass('hide');
    $.ajax({
        url: link.attr('href'),
        type: "POST",
        success: function (data) {
            buttonGroup.closest('.cell').attr('data-inventory-status', data.status);
            $('.inventory-completion', buttonGroup.closest('div.cell')).html(data.label);
            mainButton.html(data.mainActionLabel);
            mainButton.attr('href', mainButton.attr('href').replace(/inventoryStatus\/[a-zA-Z]+/, 'inventoryStatus/' + data.mainActionStatus));
            otherButton.html(data.otherActionLabel);
            otherButton.attr('href', otherButton.attr('href').replace(/inventoryStatus\/[a-zA-Z]+/, 'inventoryStatus/' + data.otherActionStatus));
            var collapse = buttonGroup.closest('.collapse[data-inventory]');
            $('.collapse[data-inventory]').attr('data-first-cell', <?=$defaultDataFirstCell?>);
            $('.collapse[data-inventory] .granularity').html('');
            $('.collapse[data-inventory]').trigger('loadCells');
            $('button.dropdown-toggle', buttonGroup).removeClass('hide');
            loadingButton.remove();
        },
        error: function (jqXHR) {
            var response = $.parseJSON(jqXHR.responseText);
            if ((typeof(response.typeError) == 'string') && (response.typeError != 'error')) {
                loadingButton.addClass('btn-' + response.typeError);
            } else {
                loadingButton.addClass('btn-danger');
            }
            if (typeof(response.message) == 'string') {
                loadingButton.html(response.message);
            } else {
                loadingButton.html('<?=___('Core', 'exception', 'applicationError')?>');
            }
        },
        complete: function () {
            mainButton.removeClass('hide');
            $('button.dropdown-toggle', buttonGroup).removeClass('hide');
        }
    });
});
$('body').on('click', '.inventory-actions .inventory-status-message', function(e) {
    $(this).remove();
});
$('body').on('click', 'a.inventory-inputs-details', function(e) {
    e.preventDefault();
});

$('.collapse').on({
    'shown.bs.collapse': function(e) {
        if (e.target == this) {
            $(this).css('overflow','visible');
        }
    },
    'hide.bs.collapse': function(e) {
        if (e.target == this) {
            $(this).css('overflow','hidden');
        }
    }
});

<?php if ($this->canAddMembers) : ?>
$('#addMember_axis').on('change', function() {
    $('#addMember > div.form-group:not(:first)').addClass('hide');
    if ($(this).val() !== '') {
        $('#addMember > div.form-group.broader-axis.' + $(this).val()).removeClass('hide');
        $('#addMember > div.form-group:not(:first):not(.broader-axis)').removeClass('hide');
    }
});
$('#addMember').on('successSubmit', function() {
    $('#addMember').first().get(0).reset();
    $('#addMember_axis').trigger('change');
});
<?php endif; ?>

$(document).ready(function() {
    $('.withTooltip').tooltip();
    $('.withPopover').popover();
    <?php if ($this->canAddMembers) : ?>
    new AjaxForm('#addMember');
    <?php endif; ?>
    $('.history > h3 a').trigger('click');
    $('.comments > h3 a').trigger('click');
    $('div.collapse[id^="granularity"]').on('show.bs.collapse',
        function(e) {
            if ((e.target != this) || ($('.granularity', $(this)).html() != '')) {
                return;
            }
            $(this).attr('data-first-cell', <?=$defaultDataFirstCell?>);
            $(this).trigger('loadCells');
            $('.granularity', $(this)).html('');
        }
    );
    $('div.collapse[id^="granularity"].in').trigger('loadCells').css('overflow','visible');
});
</script>

<?= $this->tutorial('orga'); ?>
