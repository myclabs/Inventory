<?php
?>

<fieldset class="wrapper">
    <legend style="cursor:default"><?=___('UI', 'name', 'general')?></legend>
    <div>
        <form id="organizationDetails<?=$this->idOrganization?>" class="form-horizontal" method="POST" action="orga/organization/edit-organization-submit/idOrganization/<?=$this->idOrganization?>">
            <div class="form-group">
                <label for="organization_label" class="control-label col-xs-2">
                    <?=___('UI', 'name', 'label')?>
                </label>
                <div class="col-xs-10">
                    <input name="label" id="organization_label" type="text" class="form-control" value="<?=$this->organizationLabel?>">
                </div>
            </div>
            <div class="form-group">
                <div class="col-xs-10 col-xs-offset-2">
                    <button type="submit" class="btn btn-primary"><?=__('UI', 'verb', 'save')?></button>
                </div>
            </div>
        </form>

        <script type="text/javascript">
            $(document).ready(function() {
                new AjaxForm('#organizationDetails<?=$this->idOrganization?>');
            });
        </script>
    </div>
</fieldset>

<fieldset class="wrapper">
    <legend style="cursor:default"><?=___('Orga', 'organization', 'contextIndicators')?></legend>
    <div>
        <form id="organizationContextIndicators<?=$this->idOrganization?>" class="form-horizontal" method="POST" action="orga/organization/edit-context-indicators/idOrganization/<?=$this->idOrganization?>">
            <div class="form-group">
                <label for="contextIndicators" class="control-label col-xs-2">
                    <?=___('Classification', 'contextIndicator', 'contextIndicators')?>
                </label>
                <div class="col-xs-10">
                    <select name="contextIndicators[]" multiple id="contextIndicators">
                        <?php foreach ($this->potentialContextIndicators as $contextIndicator) : ?>
                            <option value="<?=$contextIndicator->getId()?>"<?=(in_array($contextIndicator, $this->selectedContextIndicators) ? ' selected' : '')?>>
                                <?=$contextIndicator->getLabel()?> (<?=$contextIndicator->getLibrary()->getLabel()?>)
                            </option>
                        <?php endforeach ?>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="col-xs-10 col-xs-offset-2">
                    <button type="submit" class="btn btn-primary"><?=__('UI', 'verb', 'save')?></button>
                </div>
            </div>
        </form>

        <script type="text/javascript">
            $(document).ready(function() {
                $('#contextIndicators').select2();
                new AjaxForm('#organizationContextIndicators<?=$this->idOrganization?>');
            });
        </script>
    </div>
</fieldset>


<?php
$file = glob(APPLICATION_PATH . '/../public/workspaceBanners/' . $this->idOrganization . '.*');
$file = reset($file);
?>

<fieldset class="wrapper">
    <legend style="cursor:default">
        <?=___('Orga', 'organization', 'banner')?>
        <small><?=___('Orga', 'organization', 'bannerExplanations')?></small>
    </legend>
    <div>
        <form id="editBanner<?=$this->idOrganization?>" class="form-horizontal" method="POST" action="orga/organization/edit-banner/idOrganization/<?=$this->idOrganization?>" enctype="multipart/form-data" target="upload_iframe<?=$this->idOrganization?>">
            <div class="form-group">
                <label for="organization_banner" class="control-label col-xs-2">
                    <?=__('Orga', 'organization', 'choiceBanner')?>
                </label>
                <div class="col-xs-10">
                    <input name="banner" id="organization_banner" type="file">
                </div>
            </div>
            <div class="form-group">
                <span class="form-control-static control-label col-xs-2">
                    <?=___('Orga', 'organization', 'currentBanner')?>
                </span>
                <div class="col-xs-10">
                    <img id="currentBanner<?=$this->idOrganization?>" width="100%" src="<?=(($file !== false) ? 'workspaceBanners/'.pathinfo($file)['filename'] : '')?>" alt="<?=___('Orga', 'organization', 'noBanner')?>">
                </div>
            </div>
            <div class="form-group">
                <div class="col-xs-10 col-xs-offset-2">
                    <button type="submit" class="btn btn-primary"><?=__('UI', 'verb', 'save')?></button>
                    <button id="removeBanner<?=$this->idOrganization?>" class="btn btn-warning<?=(($file !== false) ? '': ' hide')?>" type="button">
                        <?=__('UI', 'verb', 'delete')?>
                    </button>
                </div>
            </div>
            <div class="form-group hide">
                <div class="col-xs-10 col-xs-offset-2">
                    <div class="uploading-banner-errors alert alert-danger"></div>
                </div>
            </div>
            <div class="form-group hide">
                <div class="col-xs-10 col-xs-offset-2">
                    <div class="uploading-banner alert alert-info">
                        <?=$this->image('images/ui/ajax-loader.gif', '')?>
                        <?=__('Doc', 'library', 'uploading')?>
                    </div>
                </div>
            </div>
        </form>

        <iframe id="upload_iframe<?=$this->idOrganization?>" name="upload_iframe<?=$this->idOrganization?>" src="#" class="hidden">
        </iframe>

        <script>
            $(document).ready(function() {
                // Début de l'upload
                $("#editBanner<?=$this->idOrganization?>").on('submit', function() {
                    $('#organization .uploading-banner').closest('.form-group').removeClass('hide');
                    $('#organization .uploading-banner-errors').closest('.form-group').addClass('hide');
                });

                // Callback appelée lorsque le téléchargement a réussi
                fileUploadResult<?=$this->idOrganization?> = function(success, message) {
                    if (success) {
                        $('#currentBanner<?=$this->idOrganization?>').attr('src', 'workspaceBanners/' + message + '?' + new Date().getTime());
                        $("#removeBanner<?=$this->idOrganization?>").removeClass('hide');
                    } else {
                        $('#organization .uploading-banner-errors').html(message);
                        $('#organization .uploading-banner-errors').closest('.form-group').removeClass('hide');
                    }
                    $('#organization .uploading-banner').closest('.form-group').addClass('hide');
                }

                // Suppression de la bannière
                $("#removeBanner<?=$this->idOrganization?>").on('click', function(e) {
                    var button = $(this);
                    if (button.hasClass('disabled')) {
                        return;
                    }
                    e.preventDefault();
                    button.addClass('disabled');
                    $.ajax({
                        url: 'orga/organization/remove-banner/idOrganization/<?=$this->idOrganization?>',
                        type: "POST",
                        success: function(data) {
                            addMessage(data.message, 'success');
                            $('#currentBanner<?=$this->idOrganization?>').attr('src', '');
                            $("#removeBanner<?=$this->idOrganization?>").addClass('hide')();
                        },
                        error: function(jqXHR) {
                            var data = $.parseJSON(jqXHR.responseText);
                            addMessage(data.message, data.typeError);
                        },
                        complete: function(jqXHR) {
                            button.removeClass('disabled');
                        }
                    });
                });
            });
        </script>
    </div>
</fieldset>
