# Exploitation

## Outils et configuration

- Apache 2
- PHP 5.4
- MySQL
- Supervisor : gestion des processus démons (workers, …)
- RabbitMQ : serveur de file de messages, utilisé pour les workers
- remote_syslog : envoie les logs à [PaperTrail](https://papertrailapp.com/), notre outil de lecture des logs

## Déploiement

Il existe un script de déploiement qui permet de déployer une version sur une *installation existante* : https://github.com/myclabs/deploy.

## Supervisor

Supervisor permet de gérer des processus démons.

Les configurations de chaque démon sont dans `/etc/supervisor/conf.d/`.

Utilisation :

```shell
$ sudo supervisorctl
 > status
inventory1-worker                RUNNING    pid 21901, uptime 2 days, 16:15:53
> restart inventory1-worker
stopping inventory1-worker
starting inventory1-worker
 > status
inventory1-worker                RUNNING    pid 13907, uptime 0 days, 00:00:02
```

Commandes :

- `status` liste les processus
- `restart ...` redémarre un processus
- `update` va prendre en compte les changements de conf et redémarrer que les processus concernés

## Workers

Configuration Supervisor (`/etc/supervisor/conf.d/inventory1.conf`) :

```
[program:inventory1-worker]
command=/usr/bin/php /home/dev/inventory/1/scripts/jobs/work/work.php

; redirige la sortie d'erreur vers stdout
redirect_stderr=true

stdout_logfile=/home/dev/inventory/1/data/logs/worker.log

autorestart=true
```

Les workers sont automatiquement redémarrés lorsqu'ils terminent.

## Gestion des logs

Les logs applicatifs sont dans :

- `data/logs/error.log`
- `data/logs/worker.log`

`remote_syslog` est un démon qui envoie les logs à [PaperTrail](https://papertrailapp.com/), notre outil de lecture des logs. Il est géré par Supervisor, car il faut une instance de `remote_syslog` par installation d'Inventory.

Installation :

```shell
$ sudo apt-get install libgemplugin-ruby
$ sudo gem install remote_syslog
```

Configuration Supervisor (`/etc/supervisor/conf.d/inventory1-logs.conf`) :

```
# Supervisor conf file for Papertrail
[program:inventory1-logs]
command=/usr/local/bin/remote_syslog -D --pid-file /var/run/remote_syslog_inventory1.pid -c /etc/log_files_inventory1.yml
user=root
group=root
autostart=true
autorestart=true
redirect_stderr=true
```

Configuration `remote_syslog` (`etc/log_files_inventory1.yml`) :

```yaml
files: 
  - /home/prod/inventory/1/data/logs/error.log
  - /home/prod/inventory/1/data/logs/worker.log

hostname: prod.inventory1

destination:
  host: logs.papertrailapp.com
  port: 14028
```
